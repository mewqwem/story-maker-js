<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>AI Story Generator</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles/style.css" />
  </head>
  <body>
    <div class="sidebar">
      <button
        class="sidebar-btn active"
        onclick="showPage('generator')"
        title="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä"
      >
        <i class="fas fa-magic"></i>
      </button>
      <button
        class="sidebar-btn"
        onclick="showPage('settings')"
        title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"
      >
        <i class="fas fa-cog"></i>
      </button>
    </div>

    <div class="content">
      <div id="page-generator" class="page active">
        <h2>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ü—Å—Ç–æ—Ä—ñ–π</h2>

        <div class="input-group">
          <label>–ù–∞–∑–≤–∞ –ü—Ä–æ–µ–∫—Ç—É:</label>
          <input type="text" id="projectName" placeholder="MyHorrorStory_01" />
        </div>

        <div class="input-group">
          <label>–§–∞–π–ª –ü—Ä–æ–º–ø—Ç—ñ–≤ (JSON):</label>
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="promptFile"
              readonly
              placeholder="–û–±–µ—Ä—ñ—Ç—å prompts.json..."
            />
            <button class="secondary" onclick="selectFile()">üìÅ –û–±—Ä–∞—Ç–∏</button>
          </div>
        </div>

        <div class="input-group">
          <label>–®–∞–±–ª–æ–Ω (Prompt Template):</label>
          <select id="promptSelect">
            <option value="" disabled selected>–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª...</option>
          </select>
        </div>

        <div class="input-group">
          <label>–ù–∞–∑–≤–∞ –Ü—Å—Ç–æ—Ä—ñ—ó (Title):</label>
          <input
            type="text"
            id="storyTitle"
            placeholder="Why You Feel Alone..."
          />
        </div>

        <div style="display: flex; gap: 10px">
          <div class="input-group" style="flex: 1">
            <label>–ú–æ–≤–∞:</label>
            <select
              id="language"
              onchange="saveConfig('lastLanguage', this.value)"
            >
              <option value="English">English</option>
              <option value="German">German</option>
              <option value="Spanish">Spanish</option>
              <option value="French">French</option>
              <option value="Ukrainian">Ukrainian</option>
            </select>
          </div>

          <div class="input-group" style="flex: 1">
            <label>–ì–æ–ª–æ—Å (Edge TTS):</label>
            <select id="voice" onchange="saveConfig('lastVoice', this.value)">
              <option value="de-DE-ConradNeural">Conrad (Germany)</option>
              <option value="de-DE-KillianNeural">Killian (Germany)</option>
              <option value="es-VE-SebastianNeural">Sebastian (Spain)</option>
              <option value="en-US-ChristopherNeural">
                Christopher (English)
              </option>

              <option value="uk-UA-OstapNeural">Ostap (UA)</option>
            </select>
          </div>

          <div class="input-group" style="flex: 1">
            <label>–ú–æ–¥–µ–ª—å AI:</label>
            <select
              id="modelSelect"
              onchange="saveConfig('lastModel', this.value)"
            >
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
              <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
              <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label>–ü–∞–ø–∫–∞ –í–∏–≤–æ–¥—É:</label>
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="outputFolder"
              readonly
              placeholder="–ö—É–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."
            />
            <button class="secondary" onclick="selectFolder()">
              üìÅ –û–±—Ä–∞—Ç–∏
            </button>
          </div>
        </div>

        <button class="primary" onclick="startProcess()">
          üöÄ –ü–æ—á–∞—Ç–∏ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—é
        </button>

        <div id="logs"></div>
      </div>

      <div id="page-settings" class="page">
        <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>

        <div class="input-group">
          <label>Google API Key:</label>
          <div class="password-container">
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..." />
            <i
              class="fas fa-eye toggle-password"
              onclick="toggleApiKeyVisibility()"
            ></i>
          </div>
        </div>

        <button class="primary" onclick="saveApiKey()" style="width: auto">
          üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–ª—é—á
        </button>
        <p
          id="saveStatus"
          style="color: #4caf50; display: none; margin-top: 10px"
        >
          –ó–±–µ—Ä–µ–∂–µ–Ω–æ!
        </p>

        <hr style="border-color: #333; margin: 20px 0" />
        <div style="color: #888; font-size: 12px">
          –í–µ—Ä—Å—ñ—è: <span id="appVersion">1.0.0</span>
        </div>
      </div>
    </div>

    <div id="updateStatus" class="update-bar"></div>

    <script>
      const { ipcRenderer } = require("electron");

      let promptsData = {};

      // === –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ü–†–ò –ó–ê–ü–£–°–ö–£ ===
      window.onload = async () => {
        // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ API –∫–ª—é—á
        const key = await ipcRenderer.invoke("get-setting", "apiKey");
        if (key) document.getElementById("apiKeyInput").value = key;

        // 2. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —à–ª—è—Ö –¥–æ prompts.json
        const savedPromptPath = await ipcRenderer.invoke(
          "get-setting",
          "promptPath"
        );
        if (savedPromptPath) {
          loadPromptsFromFile(savedPromptPath);
        }

        // 3. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–∞–ø–∫—É –≤–∏–≤–æ–¥—É
        const savedOutputDir = await ipcRenderer.invoke(
          "get-setting",
          "outputDir"
        );
        if (savedOutputDir)
          document.getElementById("outputFolder").value = savedOutputDir;

        // 4. –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –≤–∏–±—ñ—Ä –º–æ–≤–∏, –≥–æ–ª–æ—Å—É —Ç–∞ –º–æ–¥–µ–ª—ñ
        const lastVoice = await ipcRenderer.invoke("get-setting", "lastVoice");
        if (lastVoice) document.getElementById("voice").value = lastVoice;

        const lastLang = await ipcRenderer.invoke(
          "get-setting",
          "lastLanguage"
        );
        if (lastLang) document.getElementById("language").value = lastLang;

        const lastModel = await ipcRenderer.invoke("get-setting", "lastModel");
        if (lastModel) document.getElementById("modelSelect").value = lastModel;
      };

      // === –õ–û–ì–Ü–ö–ê –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –ù–ê–õ–ê–®–¢–£–í–ê–ù–¨ ===
      async function saveConfig(key, value) {
        await ipcRenderer.invoke("save-setting", key, value);
      }

      async function saveApiKey() {
        const key = document.getElementById("apiKeyInput").value;
        await saveConfig("apiKey", key);
        const status = document.getElementById("saveStatus");
        status.style.display = "block";
        setTimeout(() => (status.style.display = "none"), 3000);
      }

      // === –†–û–ë–û–¢–ê –ó –§–ê–ô–õ–ê–ú–ò ===

      // –í–∏–±—ñ—Ä JSON —Ñ–∞–π–ª—É –ø—Ä–æ–º–ø—Ç—ñ–≤
      async function selectFile() {
        const path = await ipcRenderer.invoke("select-file");
        if (path) {
          loadPromptsFromFile(path);
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —à–ª—è—Ö, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞–∑—É –Ω–µ —à—É–∫–∞—Ç–∏
          saveConfig("promptPath", path);
        }
      }

      // –ß–∏—Ç–∞–Ω–Ω—è —Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥ JSON
      async function loadPromptsFromFile(path) {
        const json = await ipcRenderer.invoke("read-json", path);
        if (json) {
          document.getElementById("promptFile").value = path;
          promptsData = json;
          const select = document.getElementById("promptSelect");
          select.innerHTML = "";

          Object.keys(json).forEach((key) => {
            const opt = document.createElement("option");
            opt.value = key;
            opt.innerText = key;
            select.appendChild(opt);
          });
        } else {
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª –∞–±–æ –≤—ñ–Ω –ø–æ—Ä–æ–∂–Ω—ñ–π!");
        }
      }

      // –í–∏–±—ñ—Ä –ø–∞–ø–∫–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
      async function selectFolder() {
        const path = await ipcRenderer.invoke("select-folder");
        if (path) {
          document.getElementById("outputFolder").value = path;
          saveConfig("outputDir", path);
        }
      }

      // === –ó–ê–ü–£–°–ö ===
      async function startProcess() {
        const logsDiv = document.getElementById("logs");
        logsDiv.innerHTML = "–ó–∞–ø—É—Å–∫...<br>";

        const data = {
          projectName: document.getElementById("projectName").value,
          templateText:
            promptsData[document.getElementById("promptSelect").value],
          title: document.getElementById("storyTitle").value,
          voice: document.getElementById("voice").value,
          language: document.getElementById("language").value,
          outputFolder: document.getElementById("outputFolder").value,
          modelName: document.getElementById("modelSelect").value,
        };

        if (!data.outputFolder || !data.templateText) {
          alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –ø—Ä–æ–º–ø—Ç—ñ–≤!");
          return;
        }

        const res = await ipcRenderer.invoke("start-process", data);
        if (!res.success) alert("–ü–æ–º–∏–ª–∫–∞: " + res.error);
      }

      // === –Ü–ù–¢–ï–†–§–ï–ô–° ===
      function showPage(pageName) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`page-${pageName}`).classList.add("active");

        const btnIndex = pageName === "generator" ? 0 : 1;
        document
          .querySelectorAll(".sidebar-btn")
          [btnIndex].classList.add("active");
      }

      function toggleApiKeyVisibility() {
        const input = document.getElementById("apiKeyInput");
        const icon = document.querySelector(".toggle-password");
        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      // –õ–æ–≥–∏ —Ç–∞ –û–Ω–æ–≤–ª–µ–Ω–Ω—è
      ipcRenderer.on("log-update", (e, msg) => {
        const logs = document.getElementById("logs");
        logs.innerHTML += `> ${msg}<br>`;
        logs.scrollTop = logs.scrollHeight;
      });

      ipcRenderer.on("update-message", (e, text) => {
        const bar = document.getElementById("updateStatus");
        bar.innerText = text;
        bar.style.display = "block";
      });
    </script>
  </body>
</html>
